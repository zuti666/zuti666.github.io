

# Hessian Matrix  Analyse



ç¬”è®°ï¼Œ å¦‚ä½•åˆ†æ ç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹æˆ–è€…å·²ç»è®­ç»ƒå¥½çš„ç¥ç»ç½‘ç»œçš„æ¢¯åº¦å˜åŒ–æƒ…å†µ



### **1. Flat Minima çš„æ¦‚å¿µ**

Flat Minimaï¼ˆå¹³å¦æå°å€¼ï¼‰æ˜¯æœºå™¨å­¦ä¹ ä¼˜åŒ–ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦ç”¨äºæè¿°æŸå¤±å‡½æ•°åœ¨å‚æ•°ç©ºé—´ä¸­çš„æå°å€¼çš„å‡ ä½•ç‰¹æ€§ã€‚

### **(1) å®šä¹‰**

å‡è®¾ç¥ç»ç½‘ç»œçš„æŸå¤±å‡½æ•°ä¸º $L(\theta)$ï¼Œå…¶ä¸­ $\theta$ æ˜¯æ¨¡å‹çš„å‚æ•°å‘é‡ã€‚ä¼˜åŒ–ç›®æ ‡æ˜¯æ‰¾åˆ°å‚æ•° $\theta^*$ ä½¿å¾— $L(\theta)$ å–å¾—æå°å€¼ï¼š
$$
\theta^* = \arg\min_{\theta} L(\theta)
$$
Flat Minima æŒ‡çš„æ˜¯**æŸå¤±å‡½æ•°åœ¨å±€éƒ¨æå°ç‚¹é™„è¿‘çš„å˜åŒ–è¾ƒç¼“æ…¢ï¼Œå³ Hessian çŸ©é˜µçš„ç‰¹å¾å€¼è¾ƒå°**ï¼š

- å¦‚æœ **Hessian çŸ©é˜µ $H = \nabla^2 L(\theta)$ çš„æœ€å¤§ç‰¹å¾å€¼ $\lambda_{\max}$ å°**ï¼Œåˆ™è¡¨ç¤ºè¯¥ç‚¹é™„è¿‘çš„æŸå¤±å‡½æ•°æ›²ç‡è¾ƒå°ï¼Œæå°å€¼è¾ƒâ€œå¹³å¦â€ã€‚
- ç›¸åï¼Œå¦‚æœ $\lambda_{\max}$ è¾ƒå¤§ï¼Œè¡¨ç¤ºè¯¥æå°å€¼çš„æ›²é¢é™¡å³­ï¼Œè¢«ç§°ä¸º **Sharp Minimaï¼ˆå°–é”æå°å€¼ï¼‰**ã€‚



ä»æ•°å­¦è§’åº¦æ¥çœ‹ï¼Œflat minima å¯ä»¥ç”¨**Hessian çŸ©é˜µ**ï¼ˆæŸå¤±å‡½æ•°çš„äºŒé˜¶å¯¼æ•°çŸ©é˜µï¼‰æ¥è¡¡é‡ï¼š

- **Sharp Minimaï¼ˆé™¡å³­æå°å€¼ï¼‰**: Hessian çŸ©é˜µçš„ç‰¹å¾å€¼è¾ƒå¤§ï¼Œæ„å‘³ç€æŸå¤±å‡½æ•°åœ¨è¯¥ç‚¹é™„è¿‘å˜åŒ–å‰§çƒˆï¼Œæ³›åŒ–èƒ½åŠ›è¾ƒå¼±ã€‚
- **Flat Minimaï¼ˆå¹³ç¼“æå°å€¼ï¼‰**: Hessian çŸ©é˜µçš„ç‰¹å¾å€¼è¾ƒå°ï¼Œæ„å‘³ç€æŸå¤±å‡½æ•°åœ¨è¯¥ç‚¹é™„è¿‘å˜åŒ–è¾ƒç¼“ï¼Œå¯¹å™ªå£°çš„é²æ£’æ€§æ›´å¼ºã€‚

å…·ä½“æ•°å­¦æè¿°ï¼š å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæŸå¤±å‡½æ•° L(Î¸)L(\theta)ï¼Œå…¶åœ¨æŸç‚¹ Î¸âˆ—\theta^* å¤„çš„äºŒé˜¶æ³°å‹’å±•å¼€ä¸ºï¼š
$$
L(\theta) \approx L(\theta^*) + \frac{1}{2} (\theta - \theta^*)^T H (\theta - \theta^*)
$$
å…¶ä¸­ï¼Œ$H = \nabla^2 L(\theta^*)$ æ˜¯ Hessian çŸ©é˜µã€‚å¦‚æœ $H$ çš„ç‰¹å¾å€¼è¾ƒå°ï¼Œåˆ™æ„å‘³ç€æŸå¤±å‡½æ•°åœ¨è¯¥ç‚¹é™„è¿‘å˜åŒ–è¾ƒç¼“ï¼Œè¯´æ˜æ˜¯ flat minimumã€‚



# 1 Hessian Matrix çŸ©é˜µ æ•°å­¦çŸ¥è¯†ä»‹ç»

## **åŸºäºç¥ç»ç½‘ç»œå’Œ LoRA æ–¹æ³•ï¼Œä½¿ç”¨å°æ‰¹æ¬¡è®¡ç®—åˆ†æ Hessian çŸ©é˜µçš„æ•°å­¦æ¨å¯¼**

### **1. Hessian çŸ©é˜µçš„å®šä¹‰**

åœ¨ç¥ç»ç½‘ç»œä¼˜åŒ–ä¸­ï¼ŒHessian çŸ©é˜µï¼ˆ$H$ï¼‰å®šä¹‰ä¸ºæŸå¤±å‡½æ•° $L(\theta)$ å…³äºå‚æ•° $\theta$ çš„äºŒé˜¶å¯¼æ•°ï¼š
$$
H= \nabla^2 L(\theta) = \frac{\partial^2 L}{\partial \theta \partial \theta^T}
$$


Hessian çŸ©é˜µ $H$ æè¿°äº†æŸå¤±å‡½æ•°çš„ **å±€éƒ¨æ›²ç‡**ï¼Œåæ˜ äº†æ¨¡å‹å‚æ•°æ›´æ–°æ—¶çš„æ–¹å‘æ€§åŠæ”¶æ•›ç‰¹æ€§ã€‚Hessian çŸ©é˜µçš„æœ€å¤§ç‰¹å¾å€¼ $\lambda_{\max}$ ä¸ä¼˜åŒ–ç¨³å®šæ€§å¯†åˆ‡ç›¸å…³ï¼š

- **è¾ƒå¤§çš„ $\lambda_{\max}$ å¯èƒ½å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸**ï¼ˆæ­¥é•¿è¿‡å¤§ï¼‰ã€‚
- **è¾ƒå°çš„ $\lambda_{\max}$ å¯èƒ½å¯¼è‡´è®­ç»ƒæ”¶æ•›å˜æ…¢**ã€‚

------

### **2. LoRA æ–¹æ³•å¼•å…¥çš„å‚æ•°åŒ–ç»“æ„**

LoRAï¼ˆLow-Rank Adaptationï¼‰æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆå¾®è°ƒï¼ˆPEFTï¼‰æ–¹æ³•ï¼Œé€šè¿‡å¯¹ç¥ç»ç½‘ç»œçš„æƒé‡çŸ©é˜µè¿›è¡Œä½ç§©è¿‘ä¼¼æ¥å‡å°‘å‚æ•°æ›´æ–°é‡ã€‚åœ¨ Transformer ç»“æ„ä¸­ï¼ŒLoRA å¯¹å‚æ•° $\theta$ è¿›è¡Œ **ä½ç§©åˆ†è§£**ï¼š
$$
\Delta W = A B
$$
å…¶ä¸­ï¼š

- $A \in \mathbb{R}^{d \times r}$ï¼Œ$B \in \mathbb{R}^{r \times d}$ï¼ˆå…¶ä¸­ $r \ll d$ï¼‰
- ä½ç§©çŸ©é˜µ $A, B$ ä»£æ›¿åŸå§‹æ¨¡å‹å‚æ•°è¿›è¡Œå¾®è°ƒ

å› æ­¤ï¼ŒLoRA çš„ Hessian çŸ©é˜µè®¡ç®—å˜ä¸ºï¼š
$$
H_{\text{LoRA}} = \nabla^2 L(\theta + A B)
$$
ç”±äº LoRA åªä¼˜åŒ– $A, B$ è€Œ **å†»ç»“åŸå§‹å‚æ•°**ï¼ŒHessian çŸ©é˜µçš„ç»´åº¦ **å¤§å¹…åº¦é™ä½**ï¼Œè®¡ç®—é‡ä¹Ÿæ˜¾è‘—å‡å°‘ã€‚

------

### **3. å°æ‰¹æ¬¡ Hessian è®¡ç®—çš„æ•°å­¦æ¨å¯¼**

#### **(1) Mini-batch è®¡ç®—å¯¹ Hessian çš„å½±å“**

å®é™…è®­ç»ƒæ—¶ï¼ŒHessian çŸ©é˜µåŸºäº **å°æ‰¹é‡ mini-batch** è®¡ç®—ï¼š
$$
H_{\mathcal{B}} = \nabla^2 L_{\mathcal{B}}(\theta)
$$
å…¶ä¸­ï¼š

- $\mathcal{B}$ æ˜¯å½“å‰ batch çš„æ•°æ®é›†
- $H_{\mathcal{B}}$ æ˜¯åŸºäº batch è®¡ç®—çš„ Hessian

ç”±äº $H_{\mathcal{B}}$ ä»…ç”±å½“å‰ batch è®¡ç®—ï¼Œå› æ­¤ **ä¸åŒ batch è®¡ç®—çš„ Hessian å¯èƒ½ä¸åŒ**ï¼Œå³ï¼š
$$
H_{\mathcal{B}_1} \neq H_{\mathcal{B}_2}
$$
ä½†å…¨æ•°æ®é›†çš„ Hessian çŸ©é˜µå®šä¹‰ä¸ºï¼š
$$
H_{\text{global}} = \mathbb{E}_{\mathcal{B}}[H_{\mathcal{B}}]
$$
åœ¨å¤§è§„æ¨¡ç¥ç»ç½‘ç»œä¸­ï¼Œè®¡ç®— $H_{\text{global}}$ ä»£ä»·æé«˜ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ **å¤šä¸ª batch é‡‡æ · $H_{\mathcal{B}}$ æ¥è¿‘ä¼¼ $H_{\text{global}}$**ã€‚

------

#### **(2) Hessian-Vector Productï¼ˆHVPï¼‰è®¡ç®—**

ç›´æ¥è®¡ç®— Hessian çŸ©é˜µ $H$ ä»£ä»·è¿‡é«˜ï¼Œå­˜å‚¨å’Œè®¡ç®—å‡å—é™ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Hessian-Vector Productï¼ˆHVPï¼‰** è®¡ç®— Hessian æœ€å¤§ç‰¹å¾å€¼ï¼š
$$
H v = \nabla^2 L(\theta) v
$$
HVP è®¡ç®—å…¬å¼ï¼š

1. è®¡ç®—æŸå¤±å‡½æ•°çš„ **ä¸€é˜¶æ¢¯åº¦**ï¼š
   $$
   g = \nabla L(\theta)
   $$
   

2. è®¡ç®— **æ¢¯åº¦å…³äºå‚æ•° $\theta$ çš„å¯¼æ•°**ï¼š 
   $$
   H v = \nabla (g^T v)
   $$
   

3. ä½¿ç”¨è‡ªåŠ¨æ±‚å¯¼æ¡†æ¶ **é¿å…æ˜¾å¼æ„é€  Hessian çŸ©é˜µ**ï¼Œä»…è®¡ç®— $Hv$ã€‚

è®¡ç®— $Hv$ åï¼Œä½¿ç”¨ **Power Iteration æ–¹æ³•** è¿‘ä¼¼ Hessian æœ€å¤§ç‰¹å¾å€¼ã€‚





------

### **4. Power Iteration è®¡ç®—æœ€å¤§ç‰¹å¾å€¼**

æœ€å¤§ç‰¹å¾å€¼ $\lambda_{\max}$ å®šä¹‰ä¸ºï¼š
$$
\lambda_{\max} = \max_v \frac{v^T H v}{v^T v}
$$
**Power Iteration æ–¹æ³•** é€šè¿‡è¿­ä»£è®¡ç®— Hessian-Vector Product é€¼è¿‘ $\lambda_{\max}$ï¼š

1. åˆå§‹åŒ–éšæœºå‘é‡ $v_0$ï¼š
   $$
   v_0 \sim \mathcal{N}(0, I)
   $$
   

2. è¿­ä»£è®¡ç®—ï¼š
   $$
    v_{k+1} = \frac{H v_k}{\| H v_k \|}, \ 
    \lambda_k = v_k^T H v_k
   $$
   

3. å½“ $\lambda_k$ æ”¶æ•›æ—¶ï¼Œå¾—åˆ°æœ€å¤§ç‰¹å¾å€¼ï¼š
   $$
   \lambda_{\max} \approx \lambda_k
   $$
   

Power Iteration ä»…éœ€è¦è®¡ç®— $H v_k$ï¼Œé¿å… Hessian çŸ©é˜µçš„å­˜å‚¨ï¼Œé€‚ç”¨äº **é«˜ç»´ç¥ç»ç½‘ç»œå‚æ•°ç©ºé—´**ã€‚

------

### **5. ç»“è®º**

1. **Hessian çŸ©é˜µåœ¨ LoRA ä¸­çš„è®¡ç®—å¤æ‚åº¦é™ä½**ï¼š
   - åŸå§‹æ¨¡å‹å‚æ•°ç»´åº¦ä¸º $d$ï¼Œè®¡ç®— $H \in \mathbb{R}^{d \times d}$ã€‚
   - LoRA å‚æ•°åŒ–åï¼ŒHessian ç»´åº¦å˜ä¸º $r \times r$ï¼ˆ$r \ll d$ï¼‰ï¼Œè®¡ç®—é‡å¤§å¹…å‡å°‘ã€‚
2. **å°æ‰¹é‡ Hessian è®¡ç®—çš„è¿‘ä¼¼æ€§**ï¼š
   - $H_{\mathcal{B}}$ ä¼°è®¡å…¨å±€ Hessian $H_{\text{global}}$ã€‚
   - å¤š batch è®¡ç®— Hessian å¯ç”¨äºåˆ†æè®­ç»ƒæ›²ç‡å˜åŒ–ã€‚
3. **Power Iteration è®¡ç®— Hessian æœ€å¤§ç‰¹å¾å€¼**ï¼š
   - ä»…éœ€è®¡ç®— Hessian-Vector Productï¼ˆHVPï¼‰ï¼Œé¿å… Hessian çŸ©é˜µå­˜å‚¨ã€‚
   - è¿­ä»£æ›´æ–° $v$ï¼Œé€æ­¥æ”¶æ•›åˆ°æœ€å¤§ç‰¹å¾å€¼ã€‚

------



## **4. Lanczos æ–¹æ³•è®¡ç®—å¤šä¸ªç‰¹å¾å€¼**

**Lanczos ç®—æ³•** æ˜¯ **Krylov å­ç©ºé—´æ–¹æ³•**ï¼Œç”¨äºè®¡ç®— Hessian çŸ©é˜µçš„å¤šä¸ªç‰¹å¾å€¼ï¼Œé€‚ç”¨äºåˆ†æ Hessian çš„æ•´ä½“è°±åˆ†å¸ƒï¼ˆä¾‹å¦‚å‰ $k$ ä¸ªæœ€å¤§ç‰¹å¾å€¼ï¼‰ã€‚

# **Lanczos æ–¹æ³•è¯¦è§£**

**Lanczos æ–¹æ³•** æ˜¯ä¸€ç§é«˜æ•ˆçš„æ•°å€¼çº¿æ€§ä»£æ•°ç®—æ³•ï¼Œå¹¿æ³›ç”¨äºè®¡ç®— **å¯¹ç§°çŸ©é˜µ**ï¼ˆå¦‚ Hessian çŸ©é˜µï¼‰çš„ **å‰ k ä¸ªç‰¹å¾å€¼å’Œç‰¹å¾å‘é‡**ã€‚å®ƒå±äº **Krylov å­ç©ºé—´æ–¹æ³•**ï¼Œèƒ½åœ¨ä¸å­˜å‚¨æ•´ä¸ªçŸ©é˜µçš„æƒ…å†µä¸‹é«˜æ•ˆæå–é‡è¦çš„è°±ä¿¡æ¯ã€‚

åœ¨æ·±åº¦å­¦ä¹ å’Œ Hessian è®¡ç®—ä¸­ï¼ŒLanczos æ–¹æ³•ç”¨äºï¼š

- **è®¡ç®—å‰ k å¤§æˆ– k å°çš„ç‰¹å¾å€¼**ï¼Œåˆ†ææ¨¡å‹æ›²ç‡ã€‚
- **è¿‘ä¼¼ Hessian è°±åˆ†å¸ƒ**ï¼Œç”¨äºä¼˜åŒ–ç¨³å®šæ€§åˆ†æã€‚
- **è®­ç»ƒè¿‡ç¨‹ä¸­ Hessian çŸ©é˜µçš„å˜åŒ–åˆ†æ**ã€‚

------

## **1. Lanczos æ–¹æ³•çš„æ•°å­¦åŸºç¡€**

Lanczos æ–¹æ³•ç”¨äºå¯¹ç§°çŸ©é˜µ $H$ï¼Œå…¶ç›®æ ‡æ˜¯å°† $H$ æŠ•å½±åˆ°ä¸€ä¸ª **è¾ƒå°çš„ k ç»´å­ç©ºé—´**ï¼Œç”Ÿæˆä¸€ä¸ª **ä¸‰å¯¹è§’çŸ©é˜µ** $T_k$ï¼Œå¹¶ç”¨ $T_k$ çš„ç‰¹å¾å€¼è¿‘ä¼¼ $H$ çš„ç‰¹å¾å€¼ã€‚

### **(1) Krylov å­ç©ºé—´**

Lanczos æ–¹æ³•åŸºäº **Krylov å­ç©ºé—´**ï¼š

Kk(H,v1)=span{v1,Hv1,H2v1,...,Hkâˆ’1v1}K_k(H, v_1) = \text{span}\{v_1, H v_1, H^2 v_1, ..., H^{k-1} v_1\}

å…¶ä¸­ï¼š

- $v_1$ æ˜¯ä¸€ä¸ªéšæœºåˆå§‹åŒ–çš„å•ä½å‘é‡ã€‚
- é€šè¿‡ä¸æ–­è®¡ç®— $H v_i$ï¼Œæˆ‘ä»¬æ„é€ äº†ä¸€ç»„æ­£äº¤åŸº $v_1, v_2, ..., v_k$ï¼Œç”¨äºè¿‘ä¼¼ç‰¹å¾å€¼è®¡ç®—ã€‚

### **(2) Lanczos è¿­ä»£**

Lanczos æ–¹æ³•é€šè¿‡é€’å½’æ„é€ ä¸€ä¸ª **ä¸‰å¯¹è§’çŸ©é˜µ** $T_k$ï¼š

HVk=VkTk+Î²kvk+1ekTH V_k = V_k T_k + \beta_k v_{k+1} e_k^T

å…¶ä¸­ï¼š

- $V_k = [v_1, v_2, ..., v_k]$ æ˜¯ Krylov å­ç©ºé—´çš„æ­£äº¤åŸºã€‚

- $T_k$ æ˜¯ä¸€ä¸ª 

  $k \times k$ ä¸‰å¯¹è§’çŸ©é˜µ

  ï¼š

  Tk=[Î±1Î²10â€¦0Î²1Î±2Î²2â€¦00Î²2Î±3â€¦0â‹®â‹®â‹®â‹±Î²kâˆ’1000Î²kâˆ’1Î±k]T_k = \begin{bmatrix} \alpha_1 & \beta_1 & 0 & \dots & 0 \\ \beta_1 & \alpha_2 & \beta_2 & \dots & 0 \\ 0 & \beta_2 & \alpha_3 & \dots & 0 \\ \vdots & \vdots & \vdots & \ddots & \beta_{k-1} \\ 0 & 0 & 0 & \beta_{k-1} & \alpha_k \end{bmatrix}

  å…¶ä¸­ï¼š

  - $\alpha_i = v_i^T H v_i$ï¼ˆå¯¹è§’å…ƒç´ ï¼‰
  - $\beta_i = | H v_i - \alpha_i v_i - \beta_{i-1} v_{i-1} |$ï¼ˆæ¬¡å¯¹è§’å…ƒç´ ï¼‰

### **(3) è®¡ç®—æ­¥éª¤**

1. **åˆå§‹åŒ–**ï¼š
   - é€‰æ‹©ä¸€ä¸ªéšæœºå•ä½å‘é‡ $v_1$ã€‚
   - è®¡ç®— $w = H v_1$ï¼Œè®¾ç½® $\alpha_1 = v_1^T w$ï¼Œå¹¶è®¡ç®— $\beta_1$ è¿›è¡Œæ­£äº¤åŒ–ã€‚
2. **Lanczos é€’æ¨å…¬å¼**ï¼š å¯¹äº $i = 1, 2, ..., k$ï¼š
   - è®¡ç®—ï¼š w=Hviâˆ’Î±iviâˆ’Î²iâˆ’1viâˆ’1w = H v_i - \alpha_i v_i - \beta_{i-1} v_{i-1}
   - è®¡ç®— $\beta_i = | w |$ å¹¶å½’ä¸€åŒ–ï¼š vi+1=wÎ²iv_{i+1} = \frac{w}{\beta_i}
   - è®¡ç®— $\alpha_{i+1} = v_{i+1}^T H v_{i+1}$
3. **è®¡ç®—ç‰¹å¾å€¼**ï¼š
   - è®¡ç®— $T_k$ çš„ç‰¹å¾å€¼ï¼Œè¿‘ä¼¼ $H$ çš„å‰ k ä¸ªç‰¹å¾å€¼ã€‚

------

## **2. Lanczos æ–¹æ³•çš„æ•°å­¦æ¨å¯¼**

å‡è®¾å·²è®¡ç®—åˆ°ç¬¬ $k$ è½®ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªæ–°çš„æ­£äº¤å‘é‡ $v_{k+1}$ï¼Œä½¿å¾— $V_{k+1}$ ä»ç„¶æ˜¯æ­£äº¤çš„ã€‚

å·²çŸ¥ï¼š

Hvk=Î±kvk+Î²kâˆ’1vkâˆ’1+rkH v_k = \alpha_k v_k + \beta_{k-1} v_{k-1} + r_k

å…¶ä¸­ $r_k$ æ˜¯å‰©ä½™é¡¹ï¼Œéœ€è¦æ­£äº¤åŒ–ï¼Œä½¿å…¶ä¸ $v_k$ å’Œ $v_{k-1}$ æ­£äº¤ï¼š

rk=Hvkâˆ’Î±kvkâˆ’Î²kâˆ’1vkâˆ’1r_k = H v_k - \alpha_k v_k - \beta_{k-1} v_{k-1}

å½’ä¸€åŒ–ï¼š

vk+1=rkÎ²k,Î²k=âˆ¥rkâˆ¥v_{k+1} = \frac{r_k}{\beta_k}, \quad \beta_k = \|r_k\|

è¿™ä¸ªè¿­ä»£è¿‡ç¨‹ä¿è¯äº†ï¼š

VkTHVk=TkV_k^T H V_k = T_k

ä»è€Œï¼Œ$T_k$ çš„ç‰¹å¾å€¼å¯ä»¥è¿‘ä¼¼ $H$ çš„å‰ k ä¸ªç‰¹å¾å€¼ã€‚

------

## **3. Lanczos æ–¹æ³•çš„è®¡ç®—å¤æ‚åº¦**

- æ¯æ¬¡è¿­ä»£è®¡ç®— $H v_k$ï¼Œè®¡ç®—ä»£ä»·ä¸º **$O(d)$**ã€‚
- è¿­ä»£ $k$ æ¬¡ï¼Œæ€»è®¡ç®—å¤æ‚åº¦ä¸º **$O(kd)$**ã€‚
- ä»…éœ€å­˜å‚¨ $k$ ä¸ªå‘é‡ï¼Œç©ºé—´å¤æ‚åº¦ä¸º **$O(kd)$**ã€‚

ä¸ Power Iteration æ–¹æ³•ç›¸æ¯”ï¼š

- **Power Iteration åªèƒ½è®¡ç®—æœ€å¤§ç‰¹å¾å€¼**ï¼ˆå¤æ‚åº¦ $O(d)$ï¼‰ã€‚
- **Lanczos æ–¹æ³•å¯ä»¥è®¡ç®—å¤šä¸ªç‰¹å¾å€¼**ï¼Œé€‚ç”¨äº Hessian è°±åˆ†æã€‚

------

## **4. Lanczos æ–¹æ³•çš„ä¼˜åŠ¿**

| æ–¹æ³•            | è®¡ç®—ç›®æ ‡                                  | è®¡ç®—å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯                     |
| --------------- | ----------------------------------------- | ---------- | ---------------------------- |
| Power Iteration | æœ€å¤§ç‰¹å¾å€¼ $\lambda_{\max}$               | $O(d)$     | Hessian æœ€å¤§ç‰¹å¾å€¼åˆ†æ       |
| Lanczos æ–¹æ³•    | å‰ k ä¸ªç‰¹å¾å€¼ $\lambda_1, ..., \lambda_k$ | $O(kd)$    | Hessian è°±åˆ†æï¼Œå¤šç‰¹å¾å€¼è®¡ç®— |

**Lanczos æ–¹æ³•çš„ä¼˜åŠ¿**ï¼š

1. **èƒ½åŒæ—¶è®¡ç®—å¤šä¸ªç‰¹å¾å€¼**ï¼ˆPower Iteration åªèƒ½è®¡ç®—æœ€å¤§ç‰¹å¾å€¼ï¼‰ã€‚
2. **é€‚ç”¨äºé«˜ç»´çŸ©é˜µçš„è°±åˆ†æ**ï¼Œé¿å…å­˜å‚¨å®Œæ•´ Hessianã€‚
3. **èƒ½åˆ†æ Hessian å˜åŒ–è¶‹åŠ¿**ï¼Œç”¨äºä¼˜åŒ–æ”¶æ•›æ€§åˆ¤æ–­ã€‚

------

## **5. åœ¨ç¥ç»ç½‘ç»œä¸­çš„åº”ç”¨**

åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼ŒLanczos æ–¹æ³•å¸¸ç”¨äºï¼š

1. **åˆ†æ Hessian çŸ©é˜µçš„è°±**ï¼Œåˆ¤æ–­ä¼˜åŒ–çš„ç¨³å®šæ€§ã€‚
2. **ç ”ç©¶ä¼˜åŒ–æ”¶æ•›æ€§**ï¼ŒæŸ¥çœ‹æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±æƒ…å†µã€‚
3. **è¯„ä¼° LoRA ç­‰ä½ç§©å¾®è°ƒæ–¹æ³•**ï¼Œè§‚å¯Ÿ Hessian ç‰¹å¾å€¼å˜åŒ–ã€‚

------

## **6. ä»£ç ç¤ºä¾‹**

```python
import numpy as np
import torch

def lanczos_algorithm(hvp_func, dim, k):
    """
    è®¡ç®— Hessian çŸ©é˜µçš„å‰ k ä¸ªç‰¹å¾å€¼
    hvp_func: Hessian-Vector Product è®¡ç®—å‡½æ•°
    dim: å‚æ•°ç»´åº¦
    k: è®¡ç®—çš„ç‰¹å¾å€¼æ•°é‡
    """
    v = torch.randn(dim).to(torch.float32).to("cuda")  # éšæœºåˆå§‹åŒ– v
    v /= torch.norm(v)
    
    alpha, beta = [], []
    V = [v]
    
    for i in range(k):
        w = hvp_func(V[-1])  # è®¡ç®— Hv
        alpha_i = torch.dot(V[-1], w)
        alpha.append(alpha_i.item())

        if i > 0:
            w -= beta[-1] * V[-2]  # å»é™¤å‰ä¸€ä¸ªæ–¹å‘åˆ†é‡
        
        w -= alpha_i * V[-1]  # æ­£äº¤åŒ–
        beta_i = torch.norm(w)
        
        if beta_i < 1e-6:  # è¿‘ä¼¼æ”¶æ•›
            break
            
        beta.append(beta_i.item())
        V.append(w / beta_i)
    
    # è®¡ç®—ä¸‰å¯¹è§’çŸ©é˜µçš„ç‰¹å¾å€¼
    T = np.diag(alpha) + np.diag(beta, k=1) + np.diag(beta, k=-1)
    eigvals = np.linalg.eigvalsh(T)
    
    return eigvals
```

------

## **7. ç»“è®º**

- **Lanczos æ–¹æ³•æ˜¯ä¸€ç§ Krylov å­ç©ºé—´æ–¹æ³•**ï¼Œç”¨äºè®¡ç®— **å¤šä¸ªç‰¹å¾å€¼**ã€‚
- **æ¯” Power Iteration æ›´å¼ºå¤§**ï¼Œèƒ½è®¡ç®— **å‰ k å¤§æˆ– k å°çš„ç‰¹å¾å€¼**ã€‚
- **é€‚ç”¨äº Hessian çŸ©é˜µåˆ†æ**ï¼Œç”¨äº **ä¼˜åŒ–ç¨³å®šæ€§åˆ¤æ–­ã€è°±åˆ†æ** ç­‰ã€‚
- **è®¡ç®—å¤æ‚åº¦ $O(kd)$ï¼Œæ¯”ç›´æ¥ç‰¹å¾åˆ†è§£é«˜æ•ˆ**ã€‚

Lanczos æ–¹æ³•æ˜¯ **æ·±åº¦å­¦ä¹ ä¼˜åŒ–ç†è®ºçš„é‡è¦å·¥å…·**ï¼Œå¸®åŠ©ç†è§£æ¨¡å‹è®­ç»ƒä¸­çš„ Hessian å˜åŒ–ï¼Œæå‡æ¨¡å‹çš„è®­ç»ƒç¨³å®šæ€§ï¼ ğŸš€



### **(1) æ ¸å¿ƒæ€æƒ³**

Lanczos æ–¹æ³•é€šè¿‡é€’å½’æ„é€ ä¸€ä¸ª **ä¸‰å¯¹è§’çŸ©é˜µ** $T_k$ï¼Œå…¶ç‰¹å¾å€¼è¿‘ä¼¼äº $H$ çš„å‰ $k$ ä¸ªç‰¹å¾å€¼ï¼š
$$
H v_i = \alpha_i v_i + \beta_{i-1} v_{i-1} + \beta_i v_{i+1}
$$
å…¶ä¸­ï¼š

- $\alpha_i = v_i^T H v_i$
- $\beta_i = | H v_i - \alpha_i v_i - \beta_{i-1} v_{i-1} |$

ç„¶åï¼Œè®¡ç®— $T_k$ çš„ç‰¹å¾å€¼ï¼Œè¿‘ä¼¼äº $H$ çš„å‰ $k$ ä¸ªç‰¹å¾å€¼ã€‚

### **(2) è®¡ç®—å¤æ‚åº¦**

- è®¡ç®— $H v$ çš„ä»£ä»·ä¸º $O(d)$ï¼Œé€‚ç”¨äºé«˜ç»´å‚æ•°ç©ºé—´ã€‚
- éœ€è¦å­˜å‚¨ $k$ ä¸ªå‘é‡ï¼Œ**ç©ºé—´å¤æ‚åº¦ä¸º $O(kd)$**ã€‚
- **é€‚ç”¨äºè®¡ç®—å¤šä¸ªç‰¹å¾å€¼ï¼ˆæœ€å¤§ã€æœ€å°ã€æˆ–è€…æŸä¸ªèŒƒå›´å†…çš„ï¼‰**ã€‚